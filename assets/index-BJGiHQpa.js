(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const Y=[["erase","@main=r&(r *)~*"]],[c,v,y]=[0,1,2],[b,q,z,le,T,R,de,D,ce]=[0,1,2,3,4,5,6,7,8],u=document.querySelector("svg#mySvg");u.setAttribute("width",document.documentElement.clientWidth.toString());u.setAttribute("height",document.documentElement.clientHeight.toString());const k=document.querySelector("#codeblock"),U=k.querySelector("#codecontent"),G=document.querySelector("#errormsg");let h=[],S=!0;function f(t,e,...n){if(!t){n.forEach(s=>s.color(!0));try{$()}catch(s){console.error(s)}throw S=!1,new Error(e)}}const K=document.createElementNS("http://www.w3.org/2000/svg","g"),B=document.createElementNS("http://www.w3.org/2000/svg","g");let d=[],m=[];class l{constructor(e,n){f(typeof e=="number"&&!isNaN(e),"x is not a number"),f(typeof n=="number"&&!isNaN(n),"y is not a number"),this.x=e,this.y=n}add(e){return new l(this.x+e.x,this.y+e.y)}sub(e){return new l(this.x-e.x,this.y-e.y)}mul(e){return new l(this.x*e,this.y*e)}slen(){return this.x**2+this.y**2}len(){return Math.sqrt(this.slen())}T(){return new l(this.y,-this.x)}static lookat(e){return new l(Math.cos(e),Math.sin(e))}normalized(){return this.mul(1/this.len())}}const M=new l(0,0),J=new l(u.clientWidth/2,u.clientHeight/2);let p=new l(0,0);class W{constructor(){this.removed=!1,this.id=Math.random().toString().slice(2),this.element=this.create_element(),this.element.setAttribute("id",this.id)}create_element(){return document.createElementNS("http://www.w3.org/2000/svg","g")}remove(){this.element.remove(),this.removed=!0,d=d.filter(e=>!e.removed),m=m.filter(e=>!e.removed),h=h.filter(e=>!e.removed)}color(e){this.element.setAttribute("stroke",e?"red":"var(--color)")}}class _ extends W{constructor(e=b,n=null){super(),this.pos=M,this.vel=M,this.connections=[null],this.port_pos=[M],this.rotation=0,this.dot=null,this.tag="",this.repforce=100,this.grav=.01,this.type=e,this.pos=n==null?new l((Math.random()-.5)*u.clientWidth,(Math.random()-.5)*u.clientHeight):n,B.appendChild(this.element),d.push(this),this.color(!1)}set_text(e){this.tag=e;let n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("x","10"),n.setAttribute("y","5"),n.textContent=e,n.setAttribute("fill","var(--color)"),this.element.appendChild(n)}create_element(){this.dot=document.createElementNS("http://www.w3.org/2000/svg","circle"),this.dot.setAttribute("r","5"),this.dot.setAttribute("stroke","var(--color)"),this.dot.id=this.id;let e=document.createElementNS("http://www.w3.org/2000/svg","g");return e.appendChild(this.dot),e}energy(){return d.map(e=>e==this?0:this.repforce/this.pos.sub(e.pos).len()).reduce((e,n)=>e+n)+this.pos.len()*this.grav}physics(){this.vel=this.vel.mul(.97).add(this.pos.normalized().mul(-this.grav)),d.forEach(n=>{if(n==this)return;let s=this.pos.sub(n.pos).slen();this.vel=this.vel.add(this.pos.sub(n.pos).normalized().mul(1/s).mul(this.repforce))});const e=.7;this.vel.len()>e&&(this.vel=this.vel.normalized().mul(e)),this.pos=this.pos.add(this.vel)}update(){if(this.removed){d=d.filter(n=>n!=this);return}f(this.connections.map(n=>n!=null).reduce((n,s)=>n&&s),"not all connections are connected",this),this.port_pos=[this.pos];let e=this.get_principal();if(e!=null){let n=e.other({node:this,side:c}).node.pos;this.rotation=Math.atan2(n.y-this.pos.y,n.x-this.pos.x)}}display(){var e;(e=this.element)==null||e.setAttribute("transform",`translate(${this.pos.x-p.x}, ${this.pos.y-p.y}) `)}get_principal(){return this.connections[0]}get_left(){return this.connections[1]}get_right(){return this.connections[2]}color(e){this.element.setAttribute("fill",e?"red":this.type==b||this.type==T?"white":"black");for(let n of this.connections)n!=null&&n.color(e)}}class H extends _{constructor(e=T,n=null){super(e,n),this.connections=[null,null,null]}create_element(){let e=document.createElementNS("http://www.w3.org/2000/svg","polygon");return e.setAttribute("stroke","var(--color)"),e}update(){super.update(),this.port_pos=[new l(10,0),new l(-5,-5),new l(-5,5)].map(e=>this.pos.add(e.T().mul(-Math.sin(this.rotation))).add(e.mul(Math.cos(this.rotation))))}display(){let e=[0,1,2].map(n=>this.pos.add(new l(10*Math.cos(this.rotation+n*Math.PI/3*2),10*Math.sin(this.rotation+n*Math.PI/3*2)).sub(p))).map(n=>`${n.x}, ${n.y}`).join(" ");this.element.setAttribute("points",e)}}class g extends W{constructor(e,n){f(e.node.connections[e.side]==null,"start preconnected",e.node),f(n.node.connections[n.side]==null,"end preconnected",n.node),f(e.node!=n.node||e.side!=n.side,"start and end are the same",e.node,n.node),super(),this.grav=.04,this.start=e,this.end=n,K.appendChild(this.element),m.push(this),this.start.node.connections[this.start.side]=this,this.end.node.connections[this.end.side]=this,e.side==c&&n.side==c&&e.node.type!=b&&n.node.type!=b&&h.push(this)}create_element(){let e=document.createElementNS("http://www.w3.org/2000/svg","path");return e.setAttribute("fill","none"),e.setAttribute("stroke","var(--color)"),e}other(e){return this.start.node==e.node&&this.start.side==e.side?this.end:this.start}update(){}color(e){super.color(e);let n=h.indexOf(this);n!=-1&&(h[n]=h[0],h[0]=this)}display(){let e=this.start.node.port_pos[this.start.side],n=this.end.node.port_pos[this.end.side],s=this.start.node.rotation+(this.start.side!=c?Math.PI:0),o=this.end.node.rotation+(this.end.side!=c?Math.PI:0),i=e.sub(n).len()/2+5,r=e.add(l.lookat(s).mul(i)).sub(p),a=n.add(l.lookat(o).mul(i)).sub(p);e=e.sub(p),n=n.sub(p);let P=`M ${e.x} ${e.y} C ${r.x} ${r.y} ${a.x} ${a.y} ${n.x} ${n.y}`;this.element.setAttribute("d",P)}physics(){if(this.start.node==this.end.node)return;let e=this.start.node.pos.sub(this.end.node.pos).normalized();this.start.node.vel=this.start.node.vel.add(e.mul(-this.grav)),this.end.node.vel=this.end.node.vel.add(e.mul(this.grav))}energy(){return this.start.node.pos.sub(this.end.node.pos).len()*this.grav}remove(){super.remove(),this.start.node.connections[this.start.side]=null,this.end.node.connections[this.end.side]=null}}const I=new Map;function Q(t){console.log("parsing code",t),I.clear(),u.innerHTML="",L(e=>e.remove()),console.log(d,m,h),t.split(`
@`).slice(1).map(e=>{console.log(`parsing function: ${e}`),e=e.replace(/\s+/g," ");const n=new Map,s=e.split("=")[0].trim(),o=e.split("=")[1].split("&"),i=new _(b);i.set_text(s),I.set(s,i),new g({node:i,side:c},A(o[0],n)),o.slice(1).forEach(r=>{try{let a=r.split("~").map(P=>A(P,n));new g(a[0],a[1])}catch(a){throw G.textContent=`error in line: ${r}`,a}})}),ie()}function A(t,e){if(t=t.trim(),!["(","{","["].includes(t[0])){if(t=="*")return{node:new _(R),side:c};if(t.startsWith("@")){let r=new _(q);return r.set_text(t),{node:r,side:c}}else if(e.has(t)){let r=e.get(t),a=r.connections[0].other({node:r,side:c});return r.remove(),r.connections[c].remove(),a}else{let r=new _(z);return e.set(t,r),{node:r,side:c}}}let n=new H(t[0]=="("?T:D);t=t.slice(1,-1);let s=0,o="";for(let r of t)if(o+=r,["(","{","["].includes(r)&&(s+=1),[")","}","]"].includes(r)&&(s-=1),([")","}","]"].includes(r)||r==" ")&&s==0)break;let i=t.slice(o.length);return new g({node:n,side:v},A(o,e)),new g({node:n,side:y},A(i,e)),{node:n,side:c}}function L(t){m.forEach(t),d.forEach(t)}function j(){L(t=>t.update())}function Z(){if(h.length>0){let t=h[0];f(t.removed==!1,"tomerge is removed");let e=t.start.node,n=t.end.node;m.forEach(s=>{if(s!=t)s.physics();else{let o=e.pos.sub(n.pos);e.pos=e.pos.add(o.normalized().mul(-.7)),n.pos=n.pos.add(o.normalized().mul(.7)),o.len()<20&&(t.remove(),oe(e,n))}}),d.forEach(s=>{s!=e&&s!=n&&s.physics()})}else L(t=>t.physics())}function F(t,e){if(e.has(t))return e.get(t);let n=new t.constructor(t.type,t.pos);return n.set_text(t.tag),e.set(t,n),t.connections.map(s=>{let[o,i]=[s.start,s.end].map(r=>({node:F(r.node,e),side:r.side}));o.node.connections[o.side]==null&&new g(o,i)}),n}function V(t,e){let[n,s]=[t,e].map(o=>{let i=o.node.connections[o.side];return i&&i.remove(),i});n&&s&&n!=s&&new g(n.other(t),s.other(e))}function ee(t,e){[v,y].map(n=>V({node:t,side:n},{node:e,side:n}))}function O(t,e){let n=e.node.connections[e.side];n.remove(),new g(t,n.other(e))}function te(t,e){let n=[0,0,1,1].map(s=>new H([e,t][s].type,[t,e][s].pos));[0,0,1,1].map((s,o)=>{let i=o%2;return new g({node:n[s],side:[v,y][i]},{node:n[2+i],side:[v,y][s]}),O({node:n[o],side:c},{node:s?e:t,side:i==0?v:y}),n[o]}).map(C)}function ne(t,e){[v,y].map(n=>{let s=new _(e.type,e.pos);return O({node:s,side:c},{node:t,side:n}),s}).map(C)}function se(t,e){let n=I.get(t),s=new Map,o=F(n,s);O({node:e,side:c},{node:o,side:c}),o.remove();for(let i of s.values())i.pos=i.pos.add(e.pos).sub(n.pos);for(let i=0;i<20;i++)for(let r of s.values())C(r)}function oe(t,e){let n=s=>s instanceof H;if(n(t)&&([t,e]=[e,t]),t.remove(),t.type==q)return se(t.tag.slice(1),e);if(e.remove(),n(t)&&n(e))e.type!=t.type?te(t,e):ee(t,e);else if(!(!n(t)&&!n(e)))if(t.type==R||t.type==z)ne(e,t);else throw new Error("invalid interaction")}function $(){f(!m.map(t=>t.removed).reduce((t,e)=>t||e),"edges are removed"),f(!d.map(t=>t.removed).reduce((t,e)=>t||e),"nodes are removed"),L(t=>t.display()),u.innerHTML=m.map(t=>t.element.outerHTML).join("")+d.map(t=>t.element.outerHTML).join("")}let x=!1;function C(t,e=100){function n(i){return i.energy()+i.connections.map(r=>{var a;return(a=r==null?void 0:r.energy())!=null?a:0}).reduce((r,a)=>r+a)}let s=n(t),o=t.pos;for(let i=0;i<4;i++)t.pos=t.pos.add(l.lookat(Math.random()*Math.PI*2).mul(e*Math.random())),n(t)>s&&(t.pos=o)}function ie(){for(let e=0;e<40;e++)d.forEach(n=>C(n));p=d.map(e=>e.pos).reduce((e,n)=>e.add(n)).mul(1/d.length).sub(J)}setInterval(()=>{d=d.filter(t=>!t.removed),m=m.filter(t=>!t.removed),h=h.filter(t=>!t.removed),!(!S||x)&&(Z(),j(),$())},1e3/30);let w,E,N;u.addEventListener("mousedown",t=>{if(w!=null&&w.color(!1),t.target!=u){let e=t.target.id;w=d.find(n=>n.id==e),w&&w.color(!0),E=w}else N=new l(t.offsetX,t.offsetY).add(p);$()});u.addEventListener("mousemove",t=>{E!=null?(E.pos=new l(t.offsetX,t.offsetY).add(p),E.vel=M,j()):N!=null&&(p=new l(-t.offsetX,-t.offsetY).add(N)),$()});document.addEventListener("mouseup",()=>N=E=void 0);{let t=`@main = res
  & {res a} ~ (b c)`;localStorage.code!=null&&(t=localStorage.code),window.location.search&&(t=window.location.search.slice(1).replace(/,/g," "),window.history.pushState({},document.title,window.location.pathname)),X(t)}function X(t){t=decodeURIComponent(t),t=(`
`+t).replace(/ +/g," "),t=t.replace(/\n ?@/g,"@@").replace(/\s+/g," "),t=t.replace(/@@/g,`

@`).replace(/&/g,`
  &`),U.value=t,Q(t),localStorage.code=t}function re(){if(!x)u.style.display="none",k.style.display="flex";else{let t=U.value;X(t),k.style.display="none",u.style.display="block"}x=!x}{const t=document.querySelector("#files");let e=document.createElement("p");t.appendChild(e),e.textContent="Examples:",Y.map(([n,s])=>{const o=document.createElement("a");o.textContent=`${n}`,o.href=`?${encodeURIComponent(s)}`,t.appendChild(o)})}document.addEventListener("keydown",t=>{t.code=="Space"&&(x||(t.preventDefault(),S=!S)),t.code=="Enter"&&t.metaKey&&re()});

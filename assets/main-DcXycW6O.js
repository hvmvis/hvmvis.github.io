/* empty css              */(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const example_nets=[["erase","@main=r&(r *)~*"],["annihilate","@main=r&(r *)~(* *)"],["commute","@main=r&(r *)~{* *}"],["call",`@main=r&(r *)~@fn
    @fn={(a a) *}`],["index0","@main=r&?((4 5) r)~0"],["index2",`@main=r
    & array ~ (1 (2 (3 (4 *))))
    & 2 ~ ?(array r)`],["operate",`@main=r
    & 22 ~ $([+ 33] r)`],["operate2",`@main=r
     & [+ 22] ~ $(33 $([+ 44] r))`]],[MAIN,LEFT,RIGHT]=[0,1,2],svgparent=document.getElementById("svgparent"),displaysvg=document.querySelector("svg#mySvg");displaysvg.setAttribute("width",document.documentElement.clientWidth.toString());displaysvg.setAttribute("height",document.documentElement.clientHeight.toString());const codeeditor=document.querySelector("#codeblock"),codecontent=codeeditor.querySelector("#codecontent");document.querySelector("#errormsg");const playbutton=document.querySelector("#playbutton"),skipbutton=document.querySelector("#skipbutton"),prevbutton=document.querySelector("#prevbutton");codeeditor.addEventListener("keydown",t=>{t.key=="Tab"&&t.preventDefault()});document.addEventListener("keydown",t=>{t.code=="Space"&&(show_code||(t.preventDefault(),toggle_running())),t.code=="ArrowRight"&&skip(),t.code=="ArrowLeft"&&undo(),t.code=="Enter"&&t.metaKey&&toggle_code()});let running=!1;function toggle_running(t){t!=null?running=t:running=!running,playbutton.setAttribute("d",running?"M 4 4 L 4 14 L 8 14 L 8 4 Z M 12 4 L 12 14 L 16 14 L 16 4 Z":"M 4 4 L 4 14 L 14 9 Z")}playbutton.parentElement.addEventListener("click",()=>toggle_running());skipbutton.parentElement.addEventListener("click",()=>skip());prevbutton.parentElement.addEventListener("click",()=>undo());toggle_running(!0);var v;(v=document.getElementById("codebutton"))==null||v.addEventListener("click",toggle_code);let merge_stack=[],history=[];function assert(t,e,...n){if(!t){n.forEach(s=>s.color(!0));try{display()}catch(s){console.error(n)}throw toggle_running(!1),new Error(e)}}const edge_group=document.createElementNS("http://www.w3.org/2000/svg","g"),node_group=document.createElementNS("http://www.w3.org/2000/svg","g");let nodes=[],edges=[];class Vec2{constructor(e,n){assert(typeof e=="number"&&!isNaN(e),"x is not a number"),assert(typeof n=="number"&&!isNaN(n),"y is not a number"),this.x=e,this.y=n}add(e){return new Vec2(this.x+e.x,this.y+e.y)}sub(e){return new Vec2(this.x-e.x,this.y-e.y)}mul(e){return new Vec2(this.x*e,this.y*e)}slen(){return this.x**2+this.y**2}len(){return Math.sqrt(this.slen())}T(){return new Vec2(this.y,-this.x)}static lookat(e){return new Vec2(Math.cos(e),Math.sin(e))}normalized(){return this.mul(1/this.len())}}const v0=new Vec2(0,0),center=new Vec2(displaysvg.clientWidth/2,displaysvg.clientHeight/2);let cam_pos=new Vec2(0,0);class Visible{constructor(){this.removed=!1,this.id=Math.random().toString().slice(2),this.element=this.create_element(),this.element.setAttribute("id",this.id),history[history.length-1].added.push(this)}create_element(){return document.createElementNS("http://www.w3.org/2000/svg","g")}remove(){this.element.remove(),this.removed=!0,nodes=nodes.filter(e=>!e.removed),edges=edges.filter(e=>!e.removed),merge_stack=merge_stack.filter(e=>!e.removed),history[history.length-1].removed.push(this)}unremove(){this.removed=!1}color(e){this.element.setAttribute("stroke",e?"red":"var(--color)")}}class Node extends Visible{constructor(e=null){super(),this.pos=v0,this.vel=v0,this.connections=[null],this.port_pos=[v0],this.rotation=0,this.tag="",this.side=MAIN,this.node=this,this.repforce=100,this.grav=.01,this.dot=this.create_dot(),this.element.appendChild(this.dot),this.pos=e==null?new Vec2((Math.random()-.5)*displaysvg.clientWidth,(Math.random()-.5)*displaysvg.clientHeight):e,node_group.appendChild(this.element),nodes.push(this),this.color(!1)}copy(){let e=new this.constructor(this.pos);return e.set_text(this.tag),e}unremove(){super.unremove(),node_group.appendChild(this.element),nodes.push(this)}set_text(e){this.tag=e;let n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("focusable","false"),n.setAttribute("x","10"),n.setAttribute("y","5"),n.textContent=e,n.setAttribute("fill","var(--color)"),this.element.appendChild(n)}create_dot(){let e=document.createElementNS("http://www.w3.org/2000/svg","circle");return e.setAttribute("r","5"),e.setAttribute("stroke","var(--color)"),e.id=this.id,e}create_element(){return document.createElementNS("http://www.w3.org/2000/svg","g")}energy(){return nodes.map(e=>e==this?0:this.repforce/this.pos.sub(e.pos).len()).reduce((e,n)=>e+n)+this.pos.len()*this.grav}physics(){this.vel=this.vel.mul(.97).add(this.pos.normalized().mul(-this.grav)),nodes.forEach(n=>{if(n==this)return;let s=this.pos.sub(n.pos).slen();this.vel=this.vel.add(this.pos.sub(n.pos).normalized().mul(1/s).mul(this.repforce))});const e=.7;this.vel.len()>e&&(this.vel=this.vel.normalized().mul(e)),this.pos=this.pos.add(this.vel)}update(){if(this.removed){nodes=nodes.filter(n=>n!=this);return}assert(this.connections.map(n=>n!=null).reduce((n,s)=>n&&s),"not all connections are connected",this),this.port_pos=[this.pos];let e=this.connections[MAIN];if(e!=null){let n=e.other({node:this,side:MAIN}).node.pos;this.rotation=Math.atan2(n.y-this.pos.y,n.x-this.pos.x)}}display(){var e;(e=this.element)==null||e.setAttribute("transform",`translate(${this.pos.x-cam_pos.x}, ${this.pos.y-cam_pos.y}) `)}other(e){var n;return((n=this.connections[e])==null?void 0:n.other({node:this,side:e}))||null}color(e){this.element.setAttribute("fill",e?"red":"black");for(let n of this.connections)n!=null&&n.color(e)}}class Binary extends Node{constructor(e=null){super(e),assert(this.constructor!=Binary,"Binary is abstract",this),this.connections=[null,null,null]}create_dot(){let e=document.createElementNS("http://www.w3.org/2000/svg","polygon");return e.setAttribute("stroke","var(--color)"),e.id=this.id,e}create_element(){return document.createElementNS("http://www.w3.org/2000/svg","g")}update(){super.update(),this.port_pos=[new Vec2(10,0),new Vec2(-5,-5),new Vec2(-5,5)].map(e=>this.pos.add(e.T().mul(-Math.sin(this.rotation))).add(e.mul(Math.cos(this.rotation))))}display(){super.display();let e=[0,1,2].map(n=>new Vec2(10*Math.cos(this.rotation+n*Math.PI/3*2),10*Math.sin(this.rotation+n*Math.PI/3*2))).map(n=>`${n.x}, ${n.y}`).join(" ");this.dot.setAttribute("points",e)}color(e){super.color(e),this.dot.setAttribute("fill",e?"red":"white")}}class Nullary extends Node{}class Erase extends Nullary{}class Ref extends Nullary{}class Out extends Nullary{color(e){super.color(e),this.dot.setAttribute("fill",e?"red":"white")}}class Num extends Nullary{constructor(e,n=null){super(),this.operator=null,assert(!(e==null&&n==null),"both value and operator are null"),this.value=e,this.operator=n,this.set_text(`#${n!=null?n:""}${e}`)}copy(){let e=new Num(this.value,this.operator);return e.pos=this.pos,e}}class Connector extends Binary{}class Duplicator extends Binary{color(e){super.color(e),this.dot.setAttribute("fill",e?"red":"black")}}class Switch extends Binary{constructor(){super(),this.set_text("?")}}class Operator extends Binary{constructor(e=null){super(e),this.set_text("$")}}class Edge extends Visible{constructor(e,n){assert(e.node.connections[e.side]==null,"start preconnected",e.node),assert(n.node.connections[n.side]==null,"end preconnected",n.node),assert(e.node!=n.node||e.side!=n.side,"start and end are the same",e.node,n.node),super(),this.grav=.04,this.start=e,this.end=n,edge_group.appendChild(this.element),edges.push(this),this.start.node.connections[this.start.side]=this,this.end.node.connections[this.end.side]=this,this.start.side==MAIN&&this.end.side==MAIN&&!(this.start.node instanceof Out)&&!(this.end.node instanceof Out)&&merge_stack.push(this)}create_element(){let e=document.createElementNS("http://www.w3.org/2000/svg","path");return e.setAttribute("fill","none"),e.setAttribute("stroke","var(--color)"),e}other(e){return this.start.node==e.node&&this.start.side==e.side?this.end:this.start}update(){}color(e){super.color(e);let n=merge_stack.indexOf(this);n!=-1&&(merge_stack[n]=merge_stack[0],merge_stack[0]=this)}display(){let e=this.start.node.port_pos[this.start.side],n=this.end.node.port_pos[this.end.side],s=this.start.node.rotation+(this.start.side!=MAIN?Math.PI:0),r=this.end.node.rotation+(this.end.side!=MAIN?Math.PI:0),o=e.sub(n).len()/2+5,i=e.add(Vec2.lookat(s).mul(o)).sub(cam_pos),u=n.add(Vec2.lookat(r).mul(o)).sub(cam_pos);e=e.sub(cam_pos),n=n.sub(cam_pos);let p=`M ${e.x} ${e.y} C ${i.x} ${i.y} ${u.x} ${u.y} ${n.x} ${n.y}`;this.element.setAttribute("d",p)}physics(){if(this.start.node==this.end.node)return;let e=this.start.node.pos.sub(this.end.node.pos).normalized();this.start.node.vel=this.start.node.vel.add(e.mul(-this.grav)),this.end.node.vel=this.end.node.vel.add(e.mul(this.grav))}energy(){return this.start.node.pos.sub(this.end.node.pos).len()*this.grav}remove(){super.remove(),this.start.node.connections[this.start.side]=null,this.end.node.connections[this.end.side]=null}unremove(){super.unremove(),edge_group.appendChild(this.element),edges.push(this),this.start.node.connections[this.start.side]=this,this.end.node.connections[this.end.side]=this,this.start.side==MAIN&&this.end.side==MAIN&&!(this.start.node instanceof Out)&&!(this.end.node instanceof Out)&&merge_stack.push(this)}}const fn_definitons=new Map;function reset(){mapall(t=>t.remove()),fn_definitons.clear(),history=[{removed:[],added:[]}],nodes=[],edges=[],merge_stack=[]}let parsed_code="";function parse_code(t){reset(),parsed_code="";const e=/@?[a-z,A-Z,0-9]+|\$\(|\?\(|\(|\)|\{|\}|\[|\]|=|&|\*|~|\+|-|\*|\/|%|=|!|&|\||\^|>>|<<|>|<|:-|:\/|:%|:>>|:<</g;let n=t.match(e)||[];console.log(n);function s(){const d=n.shift();return parsed_code+=d,d}function r(){return n[0]}const o=new Map;for(;n.length>0;)i(),n.length>0&&(parsed_code+=`

`);function i(){o.clear();const d=s();assert(d.startsWith("@"),"no @"),assert(s()=="=","no =");let l=new Out;l.set_text(d.slice(1)),fn_definitons.set(d.slice(1),l);let h=p();for(new Edge({node:l,side:MAIN},h);r()=="&";)parsed_code+=`
  `,s(),parsed_code+=" ",u()}function u(){let d=p();assert(s()=="~","no ~");let l=p();new Edge(d,l)}function p(){let d=r(),l={"(":Connector,"{":Duplicator,"$(":Operator,"?(":Switch};if(!l[d])return y();s();let h=new l[d],m=p();parsed_code+=" ",new Edge({node:h,side:LEFT},m);let c=p();new Edge({node:h,side:RIGHT},c);let a=s();return assert(a==")"||a=="}",`invalid end token ${a}`),{node:h,side:MAIN}}function y(){let d=s(),l=Erase,h="";if(d=="*")l=Erase;else if(d.startsWith("@"))l=Ref,h=d.slice(1);else{if(d[0].match(/[0-9\[]/))return _(d);{if(o.has(d)){let a=o.get(d);a.remove();let g=a.connections[MAIN].other({node:a,side:MAIN});return a.connections[MAIN].remove(),g}let c=new l;return o.set(d,c),{node:c,side:MAIN}}}let m=new l;return m.set_text(h),{node:m,side:MAIN}}function _(d){const l=/^[0-9]+$/,h=/^[-\+]?[0-9]+$/,m=/^[-\+]?[0-9]+\.[0-9]+$/;let c=null,a=null;function g(f){f.match(l)||f.match(h)?c=parseInt(f):f.match(m)&&(c=parseFloat(f))}return g(d),c==null&&(assert(d=="[","no ["),d=s(),g(d),c==null&&(a=d),g(s()),assert(s()=="]","no ]")),console.log(c,a),new Num(c,a)}layout()}function mapall(t){edges.forEach(t),nodes.forEach(t)}function update(){mapall(t=>t.update())}function skip(){if(merge_stack.length==0)return;const t=merge_stack[0];interact(t),update(),display()}function undo(){if(history.length==1)return;let t=history.pop();history.push({removed:[],added:[]}),t.added.map(e=>{e.remove()}),t.removed.map(e=>e.unremove()),history.pop(),toggle_running(!1),update(),display()}function physics(){if(merge_stack.length>0){let t=merge_stack[0];assert(t.removed==!1,"tomerge is removed");let e=t.start.node,n=t.end.node;edges.forEach(s=>{if(s!=t)s.physics();else{let r=e.pos.sub(n.pos);e.pos=e.pos.add(r.normalized().mul(-.7)),n.pos=n.pos.add(r.normalized().mul(.7)),r.len()<20&&interact(t)}}),nodes.forEach(s=>{s!=e&&s!=n&&s.physics()})}else mapall(t=>t.physics())}function copy_graph(t,e){if(e.has(t))return e.get(t);let n=t.copy();return e.set(t,n),t.connections.map(s=>{let[r,o]=[s.start,s.end].map(i=>({node:copy_graph(i.node,e),side:i.side}));r.node.connections[r.side]==null&&new Edge(r,o)}),n}function merge_ports(t,e){let[n,s]=[t,e].map(r=>{let o=r.node.connections[r.side];return o&&o.remove(),o});n&&s&&n!=s&&new Edge(n.other(t),s.other(e))}function annihilate(t,e){[LEFT,RIGHT].map(n=>merge_ports({node:t,side:n},{node:e,side:n}))}function replaceport(t,e){let n=e.node.connections[e.side];n.remove(),new Edge(t,n.other(e))}function commute(t,e){let n=[0,0,1,1].map(s=>new(s==0?e:t).constructor((s==0?t:e).pos));[0,0,1,1].map((s,r)=>{let o=r%2;new Edge({node:n[s],side:[LEFT,RIGHT][o]},{node:n[2+o],side:[LEFT,RIGHT][s]}),replaceport({node:n[r],side:MAIN},{node:s?e:t,side:o==0?LEFT:RIGHT})}),n.map(s=>anneal(10,s))}function erase(t,e){anneal(20,...[LEFT,RIGHT].map(n=>{let s=e.copy();return replaceport({node:s,side:MAIN},{node:t,side:n}),s}))}function call(t,e){const n=t.tag;console.log(call,n,e);let s=fn_definitons.get(n),r=new Map,o=copy_graph(s,r);replaceport({node:e,side:MAIN},{node:o,side:MAIN}),o.remove();for(let i of r.values())i!=o&&(i.pos=i.pos.add(e.pos.sub(o.pos)));console.log(e.other(MAIN)),console.log(r);for(let i=0;i<4;i++)for(let u of r.values())anneal(20,u)}function con(t,e,n){let s=new t;return new Edge({node:s,side:LEFT},e),new Edge({node:s,side:RIGHT},n),s}function _switch(t,e){let n=e.other(RIGHT),s=e.other(LEFT);e.connections.map(o=>o==null?void 0:o.remove()),assert(n.side==MAIN,"ret is not main",n.node);let r=new Erase(n.node.pos);if(t.value==0){let o=con(Binary,n,{node:r,side:MAIN});o.pos=e.pos,new Edge(s,o);for(let i=0;i<4;i++)anneal(100,o,r)}else if(t.value==null)assert(t.value!=null,"index value is null",t);else{r.pos=t.pos;let o=new Binary(e.pos);new Edge(s,o),new Edge(r,{node:o,side:LEFT});let i=new Switch;i.pos=e.pos;let u=new Num(t.value-1);u.pos=t.pos,new Edge(u,i),new Edge({node:o,side:RIGHT},{node:i,side:LEFT}),new Edge({node:i,side:RIGHT},n);for(let p=0;p<4;p++)anneal(100,o,i,r,u)}}function operate(Op,arg){let inp=Op.other(LEFT),out=Op.other(RIGHT);if(!(inp.node instanceof Num)){const t=Op.copy();new Edge({node:t,side:LEFT},arg),new Edge({node:t,side:RIGHT},out),new Edge({node:t,side:MAIN},inp);return}Op.connections.map(t=>t==null?void 0:t.remove()),inp.node.remove();let op=arg.operator||inp.node.operator;assert(op!=null,"no operator",arg,inp.node);let[v1,v2]=[arg.value,inp.node.value],nd;if(v1==null)console.log("v1 null"),assert(v2!=null,"both values are null",arg,inp.node),nd=new Num(v2,op);else if(v2==null)console.log("v2 null"),nd=new Num(v1,op);else{console.log(`calc ${v1} ${op} ${v2}`);let res=eval(`${v1} ${op} ${v2}`);nd=new Num(res)}new Edge({node:nd,side:MAIN},out),nd.pos=Op.pos,anneal(100,nd)}function interact(t){let[e,n]=[t.start.node,t.end.node];if(history.push({added:[],removed:[]}),t.remove(),e instanceof Binary&&([e,n]=[n,e]),e.remove(),e instanceof Ref&&n instanceof Binary&&!(n instanceof Duplicator))return call(e,n);if(n.remove(),console.log("interact",e,n),e instanceof Ref&&n instanceof Duplicator)return erase(n,e);if(console.log(1),e instanceof Ref&&n instanceof Binary)return call(e,n);if(console.log(1),e instanceof n.constructor)return annihilate(e,n);if(console.log(1),e instanceof Binary&&n instanceof Binary)return commute(e,n);if(console.log(1),e instanceof Num&&n instanceof Operator)return operate(n,e);if(console.log("not operating",e,n),e instanceof Num&&n instanceof Switch)return _switch(e,n);if(n instanceof Binary)return erase(n,e)}function display(){assert(!edges.map(t=>t.removed).reduce((t,e)=>t||e),"edges are removed"),assert(!nodes.map(t=>t.removed).reduce((t,e)=>t||e),"nodes are removed"),mapall(t=>t.display()),displaysvg.innerHTML=edges.map(t=>t.element.outerHTML).join("")+nodes.map(t=>t.element.outerHTML).join("")}let show_code=!1;function anneal(t=100,...e){function n(s){return s.energy()+s.connections.map(r=>{var o;return(o=r==null?void 0:r.energy())!=null?o:0}).reduce((r,o)=>r+o)}for(let s of e){let r=n(s),o=s.pos;for(let i=0;i<4;i++)s.pos=s.pos.add(Vec2.lookat(Math.random()*Math.PI*2).mul(t*Math.random())),n(s)>r&&(s.pos=o)}}function layout(){for(let e=0;e<40;e++)anneal(100,...nodes);cam_pos=nodes.map(e=>e.pos).reduce((e,n)=>e.add(n)).mul(1/nodes.length).sub(center)}setInterval(()=>{nodes=nodes.filter(t=>!t.removed),edges=edges.filter(t=>!t.removed),merge_stack=merge_stack.filter(t=>!t.removed),!(!running||show_code)&&(physics(),update(),display())},1e3/30);let last_target,drag_target,drag_start;displaysvg.addEventListener("mousedown",t=>{if(last_target!=null&&last_target.color(!1),t.target!=displaysvg){let e=t.target.id;last_target=nodes.find(n=>n.id==e),console.log(last_target),last_target&&last_target.color(!0),drag_target=last_target,console.log(last_target)}else drag_start=new Vec2(t.offsetX,t.offsetY).add(cam_pos);display()});displaysvg.addEventListener("mousemove",t=>{drag_target!=null?(drag_target.pos=new Vec2(t.offsetX,t.offsetY).add(cam_pos),drag_target.vel=v0,update()):drag_start!=null&&(cam_pos=new Vec2(-t.offsetX,-t.offsetY).add(drag_start)),display()});document.addEventListener("mouseup",()=>drag_start=drag_target=void 0);{let t=example_nets[2][1];localStorage.code!=null&&(t=localStorage.code),window.location.search?(t=window.location.search.slice(1).replace(/,/g," "),t=decodeURIComponent(t),window.history.pushState({},document.title,window.location.pathname),set_code(t,!0)):set_code(t)}function set_code(t,e=!1){parse_code(t),e&&(t=parsed_code),codecontent.value=t,localStorage.code=t,update(),display()}function toggle_code(){if(!show_code)svgparent.style.display="none",codeeditor.style.display="flex",codecontent.focus();else{let t=codecontent.value;set_code(t),codeeditor.style.display="none",svgparent.style.display="block"}show_code=!show_code}{const t=document.querySelector("#files");let e=document.createElement("p");t.appendChild(e),e.textContent="Examples:",example_nets.map(([s,r])=>{const o=document.createElement("a");o.textContent=`${s}`,o.href=`?${r}`,t.appendChild(o)}),t.appendChild(document.createElement("br"));let n=document.createElement("a");n.textContent="readme",n.href="/readme.html",t.appendChild(n)}
